# Оптимизация и оценка эффективности классификации языковой модели через модификацию промптов

В нашей реализации RAG модели перед тем, как начать поиск информации в векторной базе данных, вопрос пользователя и история диалога поступают в **router**. Сделано это для того, чтобы в контекст модели попадали только релевантные чанки. Но возникают **риски неверной классификации**, из-за которых ответ модели может стать совершенно неверным. Поэтому необходимо написание **качественного промпта** для router модуля.

При сравнении векторизаторов (см. Research.md) была создана таблица со сгенерированными вопросами. В данной таблице каждому вопросу сопоставлен ответ и файл (то есть класс). Таким образом, можно оценивать качество классификации router модуля.

В таблице присутствует **12 классов** (bulldog, red_mad_robot, world_class, michelin, telegram, bridges_pipes, labour. payments_taxes, education, gosuslugi, consumer_basket, cosmetics). Для каждого класса выбрано **5 вопросов**. Такое маленькое количество вопросов объясняется нежеланием автора перенагружать LLM на сервере компании. Однако, этого количества хватает для того, чтобы должным образом модифицировать промпт. Таким образом, имеем **60 вопросов** в таблице.

Изначально, эмпирическим путём был сформирован запрос, который выглядел следующим образом:
```
{context}
Проанализируй текущий вопрос пользователя и определи:
1. К какой категории относится вопрос
2. Сформулируй поисковый запрос, который наилучшим образом описывает суть вопроса
Категории:
bulldog - вопросы про французского бульдога
red_mad_robot - вопросы про компанию red_mad_robots
world_class - вопросы про фитнес-клубы World Class и тренировки
michelin - вопросы про Michelin, Мишлен
telegram - вопросы про Telegram
bridges_pipes - вопросы про мосты, трубы, трубопроводы и их конструкции
labour - вопросы про трудовой кодекс и трудовые отношения
payments_taxes - вопросы про платежи, налоги, финансы и тарифы
education - вопросы про высшее образование
gosuslugi - вопросы про платформу Госуслуги и защите от мошенников
consumer_basket - вопросы про потребительскую корзину 
cosmetics - вопросы про уход за кожей лица
brave_bison - вопросы про маркетинговую компанию Brave Bison
rectifier_technologies - вопросы про промышленную компанию Rectifier Technologies
starvest_plc - вопросы про инвестиционную компанию Starvest Plc 
chat - если вопрос не относится ни к одной из категорий

Текущий вопрос: {query}

Верни ТОЛЬКО JSON в формате:
{{"type": "название_категории", "search_query": "перефразированный поисковый запрос"}}
  ```

Данный промпт выдавал следующие точности классификации:
|Температура | Точность |
|--|--|
| 0 | 0.88 |
|0.5|0.87|
|1|0.85|

Можно сделать вывод, что для классификации **лучше выставлять температуру = 0**

Среди категорий, в которых было произведено бОльшее количество ошибок были: 
- bridges_pipes,
- gosuslugi,
- telegram,
- payments_taxes,
- education.

При детальном рассмотрении ошибок, стало ясно, что **LLM ошибалась в аббревиатурах**. 
Например, СП 35.13330.2010 относился в ТК РФ или трудности вызывал СНИЛС. 

Поэтому в следующем промпте данные аббревиатуры были расписаны более подробно (изменённые пункты отмечены *):

```
{context}  
Проанализируй текущий вопрос пользователя и определи:  
1. К какой категории относится вопрос  
2. Сформулируй поисковый запрос, который наилучшим образом описывает суть вопроса  
  
Категории:  
bulldog - вопросы про французского бульдога  
red_mad_robot - вопросы про компанию red_mad_robots  
world_class - вопросы про фитнес-клубы World Class и тренировки  
michelin - вопросы про Michelin, Мишлен  
telegram - вопросы про Telegram (Телеграм)  
* bridges_pipes - вопросы про мосты, трубы, трубопроводы и документацию к ним (например, СП 35.13330.2010)  
labour - вопросы про трудовой кодекс и трудовые отношения  
* payments_taxes - вопросы про платежи, налоги, финансы, тарифы страховые номера (СНИЛСЫ)  
education - вопросы про высшее образование
gosuslugi - вопросы про платформу Госуслуги и про способы защиты от мошенников  
consumer_basket - вопросы про потребительскую корзину 
cosmetics - вопросы про уход за кожей лица  
brave_bison - вопросы про маркетинговую компанию Brave Bison  
rectifier_technologies - вопросы про промышленную компанию Rectifier Technologies  
starvest_plc - вопросы про инвестиционную компанию Starvest Plc chat - если вопрос не относится ни к одной из категорий  
  
Текущий вопрос: {query}  
  
Верни ТОЛЬКО JSON в формате:  
{{"type": "название_категории", "search_query": "перефразированный поисковый запрос"}}
```

После этого **точность поднялась до 0.93** (аббревиатуры обрабатывались корректно)

Вторым этапом были дополнены темы, которые, как оказалось, модель не полностью понимала:
- В вопросах про высшее образование добавлена подтема о поступлении в ВУЗ
- В вопросах про Госуслуги подробнее раскрыта подтема о защите аккаунта

**Итоговое качество: 0.95**

Таким образом, с помощью данного метода оценки качества router модуля возможно увеличить качество классификации тем, изменяя промпт модели
